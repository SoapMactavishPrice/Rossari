<template>
    <div if:true={showSpinner} class="exampleHolder">
        <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
    </div>

    <template if:false={syncDataResponseFlag}>
        <div class="modal-container">
            <!-- Header -->
            <div class="modal-header">
                <h2>Update Quotation Details</h2>
                <div class="header-divider"></div>
            </div>

            <!-- Scrollable Content -->
            <div class="modal-body">
                <lightning-record-edit-form object-api-name="Quote" record-id={recordId} onsubmit={handleMainSubmit}
                    onsuccess={handleMainSuccess} onerror={handleNewError} data-id="mainform">
                    <!-- <lightning-record-edit-form object-api-name="Quote" record-id={recordId}> -->
                    <lightning-messages></lightning-messages>
                    <lightning-layout multiple-rows>

                        <lightning-layout-item size="12" padding="around-small" style="padding: 0 0 5px 0;">
                            <div class="subheaddiv">Quotation Information</div>
                        </lightning-layout-item>

                        <lightning-layout-item size="6" padding="around-small" class="pt0">
                            <label class="slds-form-element__label">
                                <span style="color: red;">* </span>
                                Sales Organisations
                            </label>
                            <lightning-input-field field-name="Sales_Organisations__c"
                                variant="label-hidden"></lightning-input-field>
                        </lightning-layout-item>
                        <lightning-layout-item size="6" padding="around-small" class="pt0">
                            <label class="slds-form-element__label">
                                <span style="color: red;">* </span>
                                Distribution Channel
                            </label>
                            <lightning-input-field field-name="Distribution_Channel__c"
                                variant="label-hidden"></lightning-input-field>
                        </lightning-layout-item>
                        <lightning-layout-item size="6" padding="around-small" class="pt0">
                            <label class="slds-form-element__label">
                                <span style="color: red;">* </span>
                                Division
                            </label>
                            <lightning-input-field field-name="Division__c"
                                variant="label-hidden"></lightning-input-field>
                        </lightning-layout-item>
                        <lightning-layout-item size="6" padding="around-small" class="pt0">
                            <label class="slds-form-element__label">
                                <span style="color: red;">* </span>
                                PO Number
                            </label>
                            <lightning-input-field field-name="PO_No__c" variant="label-hidden"></lightning-input-field>
                        </lightning-layout-item>
                        <!-- <lightning-layout-item size="6" padding="around-small" class="pt0">
                            <label class="slds-form-element__label">
                                <span style="color: red;">* </span>
                                Requested Delivery Date
                            </label>
                            <lightning-input-field field-name="RequestedDeliveryDate__c" variant="label-hidden"
                                disabled></lightning-input-field>
                        </lightning-layout-item> -->
                        <!-- <lightning-layout-item size="12" padding="around-small" class="pt0">
                            <label class="slds-form-element__label"><span style="color: red;">* </span>Partner
                                Function</label>
                            <lightning-combobox name="partnerfunction" variant="label-hidden"
                                options={partnerfunctionOptions} placeholder="Select Partner Function"
                                onchange={handleInputChange} value={partnerfunctionValue}
                                data-name="partnerfunctiondata"></lightning-combobox>
                        </lightning-layout-item> -->

                        <lightning-layout-item size="12" padding="around-small" style="padding: 0 0 10px 0;">
                            <div class="subheaddiv">Quotation Product Information</div>
                        </lightning-layout-item>
                        <lightning-layout-item size="12" padding="around-small" style="padding-top: 0 !important;">
                            <table class="slds-table slds-table_cell-buffer slds-table_bordered"
                                style="table-layout: fixed; width: 100%;">
                                <thead>
                                    <tr class="slds-line-height_reset">
                                        <th scope="col" style="background-color: #d73a2b; color: #fff; width: 20%;">
                                            <div class="slds-truncate" title="Product">Product</div>
                                        </th>
                                        <th scope="col"
                                            style="background-color: #d73a2b; color: #fff; width: 15%; text-align: right;">
                                            <div class="slds-truncate" title="Sales Price">Sales Price</div>
                                        </th>
                                        <th scope="col"
                                            style="background-color: #d73a2b; color: #fff; width: 10%; text-align: right;">
                                            <div class="slds-truncate" title="Discount">Discount</div>
                                        </th>
                                        <th scope="col"
                                            style="background-color: #d73a2b; color: #fff; width: 10%; text-align: right;">
                                            <div class="slds-truncate" title="Quantity">Quantity</div>
                                        </th>
                                        <th scope="col"
                                            style="background-color: #d73a2b; color: #fff; width: 15%; text-align: right;">
                                            <div class="slds-truncate" title="Total Price">Total Price</div>
                                        </th>
                                        <th scope="col"
                                            style="background-color: #d73a2b; color: #fff; width: 20%; text-align: center;">
                                            <div class="slds-truncate" title="Inventory">Inventory</div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template if:true={orderLineItemList} for:each={orderLineItemList} for:item="ail"
                                        for:index="Index">
                                        <tr key={ail.Id} class="slds-hint-parent">
                                            <td data-label="Product" style="vertical-align: top;">
                                                <div class="slds-truncate" title={ail.Product2.Name}>
                                                    {ail.Product2.Name}
                                                </div>
                                            </td>
                                            <td data-label="Sales Price"
                                                style="text-align: right; vertical-align: top;">
                                                <div class="slds-truncate">
                                                    {ail.UnitPrice}
                                                </div>
                                            </td>
                                            <td data-label="Discount" style="text-align: right; vertical-align: top;">
                                                <div class="slds-truncate">
                                                    {ail.Discount}
                                                </div>
                                            </td>
                                            <td data-label="Quantity" style="text-align: right; vertical-align: top;">
                                                <div class="slds-truncate">
                                                    {ail.Quantity}
                                                </div>
                                            </td>
                                            <td data-label="Total Price"
                                                style="text-align: right; vertical-align: top; padding-right: 1rem;">
                                                {ail.TotalPrice}
                                            </td>
                                            <td style="text-align: center; vertical-align: middle;">
                                                <button class="slds-button slds-button_neutral"
                                                    style="padding: 0 0.5rem; min-width: 80px;"
                                                    data-product-id={ail.Product2Id}
                                                    data-material={ail.Product2.ProductCode}
                                                    onclick={handleViewInventory}>
                                                    View
                                                </button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </lightning-layout-item>

                    </lightning-layout>
                </lightning-record-edit-form>
            </div>
            <div class="modal-footer">
                <lightning-button variant="brand" label="Send" onclick={handleMainSubmit}></lightning-button>
                <!-- <lightning-button variant="brand" label="Send" onclick={handleCallout}></lightning-button> -->
                <lightning-button label="Cancel" variant="neutral" class="slds-m-left_small" onclick={closeModal}>
                </lightning-button>
            </div>
        </div>
    </template>

    <template if:true={syncDataResponseFlag}>
        <div>
            <div class="showerror slds-p-around_medium" style="font-weight: 500;">
                <div if:true={ResponseMessage} style="display: flex;align-items: center;">
                    <svg style="height: 50px;width: 40px;margin-right: 10px;" class="slds-icon slds-icon_x-small"
                        focusable="false" data-key="check" aria-hidden="true" height="40px" width="40px" version="1.1"
                        xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" xml:space="preserve">
                        <circle style="fill:#17a717;" cx="256" cy="256" r="256" />
                        <polygon style="fill:#fff;" points="230.288,365.04 137.456,292.528 157.152,267.312 223.04,318.768 329.984,161.28 
            356.448,179.248 " />
                    </svg>
                    {ResponseMessage}
                </div>
                <div if:true={errorResponseMessage} style="display: flex;align-items: center;">
                    <svg style="height: 50px;width: 40px;margin-right: 10px;" width="40px" height="40px"
                        viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg">
                        <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"
                            sketch:type="MSPage">
                            <g id="Icon-Set-Filled" sketch:type="MSLayerGroup"
                                transform="translate(-570.000000, -1089.000000)" fill="red">
                                <path
                                    d="M591.657,1109.24 C592.048,1109.63 592.048,1110.27 591.657,1110.66 C591.267,1111.05 590.633,1111.05 590.242,1110.66 L586.006,1106.42 L581.74,1110.69 C581.346,1111.08 580.708,1111.08 580.314,1110.69 C579.921,1110.29 579.921,1109.65 580.314,1109.26 L584.58,1104.99 L580.344,1100.76 C579.953,1100.37 579.953,1099.73 580.344,1099.34 C580.733,1098.95 581.367,1098.95 581.758,1099.34 L585.994,1103.58 L590.292,1099.28 C590.686,1098.89 591.323,1098.89 591.717,1099.28 C592.11,1099.68 592.11,1100.31 591.717,1100.71 L587.42,1105.01 L591.657,1109.24 L591.657,1109.24 Z M586,1089 C577.163,1089 570,1096.16 570,1105 C570,1113.84 577.163,1121 586,1121 C594.837,1121 602,1113.84 602,1105 C602,1096.16 594.837,1089 586,1089 L586,1089 Z"
                                    id="cross-circle" sketch:type="MSShapeGroup">
                                </path>
                            </g>
                        </g>
                    </svg>
                    {errorResponseMessage}
                </div>

            </div>
        </div>
    </template>

    <!-- Inventory Modal -->
    <template if:true={showInventoryModal}>
        <section role="dialog" tabindex="-1" aria-modal="true" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container" style="max-width: 95%; min-width: 90%;">
                <!-- Modal Header -->
                <div class="slds-modal__header">
                    <h2 class="slds-text-heading_medium">Inventory Details - {selectedProductName}</h2>
                    <button class="slds-button slds-button_icon slds-modal__close" title="Close"
                        onclick={closeInventoryModal}>
                        <lightning-icon icon-name="utility:close" size="small"></lightning-icon>
                        <span class="slds-assistive-text">Close</span>
                    </button>
                </div>

                <!-- Modal Body -->
                <div class="slds-modal__content slds-p-around_medium"
                    style="min-height: 300px; max-height: 70vh; overflow: hidden;">
                    <template if:true={isLoading}>
                        <div class="slds-is-relative" style="height: 100px;">
                            <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
                        </div>
                    </template>
                    <template if:false={isLoading}>
                        <template if:true={inventoryData}>
                            <div class="slds-scrollable" style="max-height: 65vh; overflow-y: auto;">
                                <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_striped"
                                    aria-label="Inventory Data">
                                    <thead>
                                        <tr class="slds-line-height_reset">
                                            <th scope="col" style="width: 15%;">
                                                <div class="slds-truncate" title="Batch">Batch</div>
                                            </th>
                                            <th scope="col" style="width: 10%;">
                                                <div class="slds-truncate" title="Plant">Plant</div>
                                            </th>
                                            <th scope="col" style="width: 15%;">
                                                <div class="slds-truncate" title="Storage Location">Storage Location
                                                </div>
                                            </th>
                                            <th scope="col" style="width: 15%; text-align: right;">
                                                <div class="slds-truncate" title="Stock">Stock</div>
                                            </th>
                                            <!-- <th scope="col" style="width: 15%;">
                                                <div class="slds-truncate" title="Mfg Date">Mfg Date</div>
                                            </th>
                                            <th scope="col" style="width: 15%;">
                                                <div class="slds-truncate" title="Expiry Date">Expiry Date</div>
                                            </th> -->
                                            <th scope="col" style="width: 15%; text-align: right;">
                                                <div class="slds-truncate" title="Value">Value</div>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template for:each={inventoryData} for:item="item">
                                            <tr key={item.batchNumber} class="slds-hint-parent">
                                                <td data-label="Batch">
                                                    <div class="slds-truncate" title={item.batchNumber}>
                                                        {item.batchNumber}</div>
                                                </td>
                                                <td data-label="Plant">
                                                    <div class="slds-truncate" title={item.plant}>{item.plant}</div>
                                                </td>
                                                <td data-label="Storage Location">
                                                    <div class="slds-truncate" title={item.storageLocationDescription}>
                                                        {item.storageLocationDescription}</div>
                                                </td>
                                                <td data-label="Stock" style="text-align: right;">
                                                    <div class="slds-truncate">
                                                        {item.unrestrictedUseStock} {item.baseUnitOfMeasure}
                                                    </div>
                                                </td>
                                                <!-- <td data-label="Mfg Date">
                                                    <div class="slds-truncate">{item.dateOfManufacture}</div>
                                                </td>
                                                <td data-label="Expiry Date">
                                                    <div class="slds-truncate">{item.shelfLifeExpirationDate}</div>
                                                </td> -->
                                                <td data-label="Value" style="text-align: right;">
                                                    <div class="slds-truncate">
                                                        {item.valueOfUnrestrictedStock} {item.currencyKey}
                                                    </div>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                            <!-- <div class="slds-p-top_medium slds-text-align_right">
                                <div class="slds-text-body_regular">
                                    <strong>Totals:</strong> {totalsDisplay}
                                </div>
                            </div> -->
                        </template>
                        <template if:false={hasInventoryData}>
                            <div class="slds-text-align_center slds-p-vertical_xx-large">
                                No inventory data available for this product.
                            </div>
                        </template>
                    </template>
                </div>

                <!-- Modal Footer -->
                <div class="slds-modal__footer">
                    <button class="slds-button slds-button_neutral" onclick={closeInventoryModal}>Close</button>
                </div>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>

</template>