<template>
    <lightning-quick-action-panel>
        <div class="container" if:true={isNotLoading}>
            <!-- Header Section -->
            <!-- <div class="slds-p-around_small slds-text-align_center header-section">
                <h1 class="slds-text-heading_medium slds-text-color_inverse">EXPENSE REQUEST</h1>
            </div> -->

            <div class="slds-scrollable_x custom-scroll">
                <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_col-bordered">
                    <thead>
                        <tr>
                            <th
                                style="text-align: center;font-size: 15px;font-weight: bold;background-color: #9d0b0f;padding: 4px 6px;color: white;">
                                Expense Request
                            </th>
                        </tr>
                    </thead>
                </table>
            </div>

            <!-- Main Form -->
            <div class="slds-p-around_medium form-section">
                <!-- Basic Information -->
                <div class="slds-grid slds-wrap slds-gutters">

                    <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4">
                        <c-visit-report-lookup 
                            onselected={handleVisitReportSelected}
                            selected-record-id={visitReportId} 
                            selected-record-name={visitReportName}>
                        </c-visit-report-lookup>
                    </div>

                    <!-- <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4">
                        <lightning-input type="text" label="Voucher No" value={expenseName} data-name="Name"
                            onchange={handleNameChange} variant="label-stacked" disabled>
                        </lightning-input>
                    </div> -->

                    <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4">
                        <lightning-input type="date" label="Expense Date" value={todayDate} data-name="Date__c" required
                            onchange={handleDateChange} variant="label-stacked">
                        </lightning-input>
                    </div>

                    <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4">
                        <lightning-combobox name="voucherType" label="Type of Voucher" value={selectedVoucherType}
                            options={voucherOptions} onchange={handleVoucherTypeChange} variant="label-stacked"
                            required>
                        </lightning-combobox>
                    </div>

                    <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4">
                        <lightning-combobox label="Employee Name" value={selectedEmployeeId}
                            placeholder="Select Employee" options={employeeOptions} onchange={handleEmployeeChange}
                            disabled variant="label-stacked" required>
                        </lightning-combobox>
                    </div>

                    <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4">
                        <lightning-input type="text" label="Grade" value={userGradeName} disabled
                            variant="label-stacked">
                        </lightning-input>
                    </div>

                    <!-- <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4">
                        <lightning-input type="text" label="Division" value={division} disabled
                            variant="label-stacked"></lightning-input>
                    </div> -->

                    <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4">
                        <lightning-combobox name="salesType" label="Sales Type" value={salesType}
                            options={salesTypeOptions} onchange={handleSalesTypeChange} required>
                        </lightning-combobox>
                    </div>

                    <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4">
                        <lightning-input type="text" label="Zone" value={zone} disabled
                            variant="label-stacked"></lightning-input>
                    </div>

                    <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4">
                        <lightning-combobox name="currency" label="Currency" value={selectedCurrency}
                            options={currencyOptions} onchange={handleCurrencyChange} variant="label-stacked" required>
                        </lightning-combobox>
                    </div>

                    <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4" style="margin-top: -17px;"
                        if:true={showCityField}>
                        <c-city-lookup-component onselected={handleCitySelected} selected-record-id={selectedCityId}
                            selected-record-name={selectedCityName}>
                        </c-city-lookup-component>
                    </div>

                    <!-- Team Members Multi-Select (Visible only for Outstation) -->
                    <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4" 
                        if:true={showTourLookup}>
                        <c-user-multi-select-lookup
                            label="Team Members"
                            placeholder="Search team members..."
                            max-results="8"
                            onselectionchange={handleTeamMembersChange}>
                        </c-user-multi-select-lookup>
                    </div>

                    <!-- Tour Lookup Field (Visible only for Outstation) -->
                    <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4" if:true={showTourLookup}>
                        <c-tour-lookup-component label="Tour" onselected={handleTourSelected}></c-tour-lookup-component>
                    </div>

                    <!-- <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4"></div> -->

                    <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4">
                        <template if:true={selectedTourId}>
                            <c-account-lookup-component label="Customer Visited" tour-id={selectedTourId}
                                onselected={handleAccountSelected} onremoved={handleAccountRemoved}>
                            </c-account-lookup-component>
                        </template>
                    </div>
                </div>

                <!-- Line Items Section -->
                <div class="slds-m-top_large" style="overflow-x: auto; max-width: 100%; padding-bottom: 100px;">
                    <!-- <div class="slds-text-heading_small slds-m-bottom_small">Expense Line Items</div> -->

                    <table class="slds-table slds-table_bordered slds-table_cell-buffer line-items-table">
                        <thead>
                            <tr class="slds-text-title">
                                <th class="expense-type"
                                    style="text-align: center; font-size: 13px; background-color: #9d0b0f; font-weight: bold; padding: 4px 6px; color: white;">
                                    Type of Expense
                                </th>
                                <th class="date" if:true={showOutstationFields}
                                    style="text-align: center; font-size: 13px; background-color: #9d0b0f; font-weight: bold; padding: 4px 6px; color: white;">
                                    Date
                                </th>
                                <th class="mode-of-travel" if:true={showModeOfTravelField}
                                    style="text-align: center; font-size: 13px; background-color: #9d0b0f; font-weight: bold; padding: 4px 6px; color: white;">
                                    Mode of Travel
                                </th>
                                <th class="transport-mode" if:true={showLocalFields}
                                    style="text-align: center; font-size: 13px; background-color: #9d0b0f; font-weight: bold; padding: 4px 6px; color: white;">
                                    Mode
                                </th>
                                <th class="transport-mode-outstation" if:true={showOutstationFields}
                                    style="text-align: center; font-size: 13px; background-color: #9d0b0f; font-weight: bold; padding: 4px 6px; color: white;">
                                    Mode
                                </th>
                                <th class="from-location" if:true={showLocalFields}
                                    style="text-align: center; font-size: 13px; background-color: #9d0b0f; font-weight: bold; padding: 4px 6px; color: white;">
                                    From Location
                                </th>
                                <th class="to-location" if:true={showLocalFields}
                                    style="text-align: center; font-size: 13px; background-color: #9d0b0f; font-weight: bold; padding: 4px 6px; color: white;">
                                    To Location
                                </th>
                                <th class="from-location-outstation" if:true={showOutstationFields}
                                    style="text-align: center; font-size: 13px; background-color: #9d0b0f; font-weight: bold; padding: 4px 6px; color: white;">
                                    From Location
                                </th>
                                <th class="to-location-outstation" if:true={showOutstationFields}
                                    style="text-align: center; font-size: 13px; background-color: #9d0b0f; font-weight: bold; padding: 4px 6px; color: white;">
                                    To Location
                                </th>
                                <th class="start-km" if:true={showKMOrTollParkingField}
                                    style="text-align: center; font-size: 13px; background-color: #9d0b0f; font-weight: bold; padding: 4px 6px; color: white;">
                                    Start KM
                                </th>
                                <th class="end-km" if:true={showKMOrTollParkingField}
                                    style="text-align: center; font-size: 13px; background-color: #9d0b0f; font-weight: bold; padding: 4px 6px; color: white;">
                                    End KM
                                </th>
                                <th class="km-rate" if:true={showKMFields}
                                    style="text-align: center; font-size: 13px; background-color: #9d0b0f; font-weight: bold; padding: 4px 6px; color: white;">
                                    KM Rate/Fare
                                </th>
                                <th class="toll-parking" if:true={showTollParkingField}
                                    style="text-align: center; font-size: 13px; background-color: #9d0b0f; font-weight: bold; padding: 4px 6px; color: white;">
                                    Toll/Parking
                                </th>
                                <!-- <th class="company-ticket" if:true={showOutstationFields}
                                    style="text-align: center; font-size: 13px; background-color: #9d0b0f; font-weight: bold; padding: 4px 6px; color: white;">
                                    Company Ticket?
                                </th> -->
                                <th class="description" if:true={showOutstationFields}
                                    style="text-align: center; font-size: 13px; background-color: #9d0b0f; font-weight: bold; padding: 4px 6px; color: white;">
                                    Description
                                </th>

                                <th class="amount"
                                    style="text-align: center; font-size: 13px; background-color: #9d0b0f; font-weight: bold; padding: 4px 6px; color: white;">
                                    <template if:true={showLocalFields}>
                                        Amount Claimed<br>
                                    </template>
                                    <template if:false={showLocalFields}>
                                        Amount Claimed
                                    </template>
                                </th>

                                <th class="daily-allowance" if:true={showDailyAllowanceColumn}
                                    style="text-align: center; font-size: 13px; background-color: #9d0b0f; font-weight: bold; padding: 4px 6px; color: white;">
                                    {dailyAllowanceColumnLabel}
                                </th>

                                <th class="total" if:true={showTotalColumn}
                                    style="text-align: center; font-size: 13px; background-color: #9d0b0f; font-weight: bold; padding: 4px 6px; color: white;">
                                    Total
                                </th>

                                <th class="remark" if:true={showRemarkColumn}
                                    style="text-align: center; font-size: 13px; background-color: #9d0b0f; font-weight: bold; padding: 4px 6px; color: white;">
                                    Remark
                                </th>
                                <th class="reason" if:true={showReasonColumn}
                                    style="text-align: center; font-size: 13px; background-color: #9d0b0f; font-weight: bold; padding: 4px 6px; color: white;">
                                    Reason
                                </th>
                                <th class="reason-outstation" if:true={showOutstationFields}
                                    style="text-align: center; font-size: 13px; background-color: #9d0b0f; font-weight: bold; padding: 4px 6px; color: white;">
                                    Reason
                                </th>
                                <th class="description-cash" if:true={showCashFields}
                                    style="text-align: center; font-size: 13px; background-color: #9d0b0f; font-weight: bold; padding: 4px 6px; color: white;">
                                    Particulars
                                </th>
                                <th class="files"
                                    style="text-align: center; font-size: 13px; background-color: #9d0b0f; font-weight: bold; padding: 4px 6px; color: white;">
                                    Upload Files
                                </th>
                                <th class="actions"
                                    style="text-align: center; font-size: 13px; background-color: #9d0b0f; font-weight: bold; padding: 4px 6px; color: white;">
                                    Actions
                                </th>
                            </tr>
                        </thead>

                        <tbody>
                            <template for:each={lineItems} for:item="item" for:index="index">
                                <tr key={item.key} class="line-item-row">
                                    <td>
                                        <lightning-combobox name="typeOfExpense" data-index={index}
                                            options={typeOfExpenseOptions} value={item.typeOfExpenseId}
                                            onchange={handleTypeOfExpenseChange} variant="label-hidden" required>
                                        </lightning-combobox>
                                    </td>
                                    <td if:true={showOutstationFields}>
                                        <lightning-input type="date" value={item.outstationDate} data-index={index}
                                            onchange={handleOutstationDateChange} variant="label-hidden"
                                            required={showOutstationFields}>
                                        </lightning-input>
                                    </td>
                                    <td if:true={showModeOfTravelField}>
                                        <lightning-combobox name="modeOfTravel" value={item.modeOfTravel}
                                            data-index={index} options={modeOfTravelOptions}
                                            onchange={handleModeOfTravelChange} variant="label-hidden"
                                            required={showModeOfTravelField} disabled={item.computedLocationDisabled}>
                                        </lightning-combobox>
                                    </td>
                                    <td if:true={showLocalFields}>
                                        <lightning-combobox name="transportMode" value={item.transportMode}
                                            data-index={index} options={item.transportOptions}
                                            onchange={handleTransportModeChange} variant="label-hidden"
                                            required={showLocalFields} disabled={item.computedTransportDisabled}>
                                        </lightning-combobox>
                                    </td>
                                    <td if:true={showOutstationFields}>
                                        <lightning-combobox name="outstationTransportMode"
                                            value={item.outstationTransportMode} data-index={index}
                                            options={item.transportOptions}
                                            onchange={handleOutstationTransportModeChange} variant="label-hidden"
                                            required={showOutstationFields} disabled={item.computedTransportDisabled}>
                                        </lightning-combobox>
                                    </td>
                                    <td if:true={showLocalFields}>
                                        <lightning-input type="text" value={item.fromLocation} data-index={index}
                                            onchange={handleFromLocationChange} variant="label-hidden"
                                            required={showLocalFields} disabled={item.computedLocationDisabled}>
                                        </lightning-input>
                                    </td>

                                    <td if:true={showLocalFields}>
                                        <lightning-input type="text" value={item.toLocation} data-index={index}
                                            onchange={handleToLocationChange} variant="label-hidden"
                                            required={showLocalFields} disabled={item.computedLocationDisabled}>
                                        </lightning-input>
                                    </td>

                                    <td if:true={showOutstationFields}>
                                        <lightning-input type="text" value={item.outstationFromLocation}
                                            data-index={index} onchange={handleOutstationFromLocationChange}
                                            variant="label-hidden" required={showOutstationFields}
                                            disabled={item.computedLocationDisabled}>
                                        </lightning-input>
                                    </td>

                                    <td if:true={showOutstationFields}>
                                        <lightning-input type="text" value={item.outstationToLocation}
                                            data-index={index} onchange={handleOutstationToLocationChange}
                                            variant="label-hidden" required={showOutstationFields}
                                            disabled={item.computedLocationDisabled}>
                                        </lightning-input>
                                    </td>

                                    <td if:true={showKMOrTollParkingField}>
                                        <lightning-input type="number" value={item.startKM} data-index={index}
                                            onchange={handleStartKMChange} variant="label-hidden" step="0.1"
                                            required={item.isPrivate} disabled={item.disableKMFields}>
                                        </lightning-input>
                                    </td>
                                    <td if:true={showKMOrTollParkingField}>
                                        <lightning-input type="number" value={item.endKM} data-index={index}
                                            onchange={handleEndKMChange} variant="label-hidden" step="0.1"
                                            required={item.isPrivate} disabled={item.disableKMFields}>
                                        </lightning-input>
                                    </td>
                                    <td if:true={showKMFields}>
                                        <div class="slds-input-has-fixed-addon">
                                            <span class="slds-form-element__addon">
                                                {currencySymbol}
                                            </span>
                                            <lightning-input type="number" value={item.kmRate} data-index={index}
                                                onchange={handleKMRateChange} variant="label-hidden" step="0.01"
                                                required={showKMFields} disabled>
                                            </lightning-input>
                                        </div>
                                    </td>
                                    <td if:true={showTollParkingField}>
                                        <div class="slds-input-has-fixed-addon">
                                            <span class="slds-form-element__addon">
                                                {currencySymbol}
                                            </span>
                                            <lightning-input type="number" value={item.tollParking} data-index={index}
                                                onchange={handleTollParkingChange} variant="label-hidden" step="0.01"
                                                disabled={item.disableTollParking}>
                                            </lightning-input>
                                        </div>
                                    </td>
                                    <!-- <td if:true={showOutstationFields} class="slds-text-align_center">
                                        <lightning-input type="checkbox" checked={item.ticketBookedByCompany}
                                            data-index={index} onchange={handleTicketBookedChange}
                                            variant="label-hidden">
                                        </lightning-input>
                                    </td> -->
                                    <td if:true={showOutstationFields}>
                                        <lightning-textarea value={item.outstationDescription}
                                            placeholder="Enter description" data-index={index}
                                            onchange={handleOutstationDescriptionChange} variant="label-hidden">
                                        </lightning-textarea>
                                    </td>

                                    <td>
                                        <div class="slds-input-has-fixed-addon">
                                            <span class="slds-form-element__addon">
                                                {currencySymbol}
                                            </span>
                                            <lightning-input type="number" value={item.amountClaimed} data-index={index}
                                                onchange={handleAmountClaimedChange} variant="label-hidden" step="0.01"
                                                required>
                                            </lightning-input>
                                        </div>
                                        <template if:true={showLimitation}>
                                            <div class="slds-text-color_weak slds-text-align_center slds-m-top_xx-small"
                                                style="font-size: 0.75rem;">
                                                {item.limitationText}
                                            </div>
                                        </template>
                                    </td>

                                    <td if:true={showDailyAllowanceColumn}>
                                        <div class="slds-input-has-fixed-addon">
                                            <span class="slds-form-element__addon">
                                                {currencySymbol}
                                            </span>
                                            <lightning-input type="number" value={item.dailyAllowance}
                                                data-index={index} onchange={handleDailyAllowanceChange}
                                                variant="label-hidden" step="0.01"
                                                disabled={item.disableDailyAllowance}>
                                            </lightning-input>
                                        </div>
                                    </td>

                                    <!-- Total Column -->
                                    <td if:true={showTotalColumn}>
                                        <div class="slds-input-has-fixed-addon">
                                            <span class="slds-form-element__addon">
                                                {currencySymbol}
                                            </span>
                                            <lightning-input type="number" value={item.total} data-index={index}
                                                variant="label-hidden" disabled>
                                            </lightning-input>
                                        </div>
                                    </td>

                                    <td if:true={showRemarkColumn} style="width: 20%;">
                                        <lightning-input value={item.remark}
                                            placeholder="Enter remark for Special voucher" data-index={index}
                                            onchange={handleRemarkChange} variant="label-hidden"
                                            required={showRemarkColumn}>
                                        </lightning-input>
                                    </td>

                                    <td if:true={showReasonColumn}>
                                        <lightning-textarea value={item.reason}
                                            placeholder="Enter reason for Misc expense" data-index={index}
                                            onchange={handleReasonChange} variant="label-hidden"
                                            required={showReasonColumn}>
                                        </lightning-textarea>
                                    </td>
                                    <td if:true={showOutstationFields}>
                                        <lightning-textarea value={item.outstationReason} placeholder="Enter reason"
                                            data-index={index} onchange={handleOutstationReasonChange}
                                            variant="label-hidden">
                                        </lightning-textarea>
                                    </td>
                                    <td if:true={showCashFields}>
                                        <lightning-textarea value={item.cashDescription} placeholder="Enter description"
                                            data-index={index} onchange={handleCashDescriptionChange}
                                            variant="label-hidden">
                                        </lightning-textarea>
                                    </td>

                                    <td class="file-cell" style="margin-top: -23px;">
                                        <lightning-file-upload name="fileUploader" accept={acceptedFormats} multiple
                                            onuploadfinished={handleFileUpload} data-index={index} class="file-uploader"
                                            variant="label-hidden" style="margin-top: -23px;">
                                        </lightning-file-upload>

                                        <template if:true={item.fileCount}>
                                            <div class="slds-m-top_xx-small file-count-section">
                                                <div class="slds-text-color_weak slds-text-align_center">
                                                    {item.fileCount} file(s) attached
                                                </div>
                                            </div>
                                        </template>
                                    </td>

                                    <!-- File Preview Modal -->
                                    <template if:true={isFilePreviewModalOpen}>
                                        <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" class="slds-modal slds-fade-in-open">
                                            <div class="slds-modal__container">
                                                <header class="slds-modal__header">
                                                    <h2 class="slds-text-heading_medium">Uploaded Files</h2>
                                                    <button
                                                        class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse"
                                                        title="Close" 
                                                        onclick={closeFilePreviewModal}>
                                                        <lightning-icon icon-name="utility:close" alternative-text="close"
                                                            size="small"></lightning-icon>
                                                        <span class="slds-assistive-text">Close</span>
                                                    </button>
                                                </header>
                                                <div class="slds-modal__content slds-p-around_medium">
                                                    <template if:true={currentPreviewFiles.length}>
                                                        <div class="slds-text-align_center slds-m-bottom_medium">
                                                            <lightning-icon icon-name="utility:attachment" size="small"></lightning-icon>
                                                            <span class="slds-m-left_x-small slds-text-body_regular">
                                                                {currentPreviewFiles.length} file(s) uploaded for this line item
                                                            </span>
                                                        </div>
                                                        <template for:each={currentPreviewFiles} for:item="file">
                                                            <div key={file.documentId} class="slds-grid slds-gutters slds-m-bottom_small file-preview-item">
                                                                <div class="slds-col slds-size_8-of-12 slds-align-middle">
                                                                    <lightning-icon icon-name="doctype:unknown" size="small" class="slds-m-right_x-small"></lightning-icon>
                                                                    <span class="slds-text-body_regular">{file.name}</span>
                                                                </div>
                                                                <div class="slds-col slds-size_4-of-12 slds-text-align_right">
                                                                    <lightning-button-icon
                                                                        icon-name="utility:preview"
                                                                        alternative-text="Preview"
                                                                        title="Preview File"
                                                                        data-file-id={file.documentId}
                                                                        onclick={handleModalFilePreview}
                                                                        variant="border-filled"
                                                                        class="slds-m-right_x-small">
                                                                    </lightning-button-icon>
                                                                   
                                                                </div>
                                                            </div>
                                                        </template>
                                                    </template>
                                                    <template if:false={currentPreviewFiles.length}>
                                                        <p class="slds-text-align_center slds-text-body_regular">No files uploaded for this line item</p>
                                                    </template>
                                                </div>
                                                <footer class="slds-modal__footer">
                                                    <lightning-button variant="neutral" label="Close" onclick={closeFilePreviewModal}></lightning-button>
                                                </footer>
                                            </div>
                                        </section>
                                        <div class="slds-backdrop slds-backdrop_open"></div>
                                    </template>

                                    <td class="slds-text-align_center">
                                        <!-- Eye icon for viewing files - Only show if files are uploaded -->
                                        <template if:true={item.fileCount}>
                                            <lightning-button-icon 
                                                icon-name="utility:preview" 
                                                alternative-text="View Files"
                                                title="View Uploaded Files"
                                                onclick={openFilePreviewModal}
                                                data-index={index}
                                                class="slds-m-right_x-small view-files-btn"
                                                variant="border-filled">
                                            </lightning-button-icon>
                                        </template>

                                        <lightning-button-icon icon-name="utility:add" alternative-text="Add"
                                            onclick={addLineItem} class="slds-m-right_x-small" variant="border-filled">
                                        </lightning-button-icon>
                                        <lightning-button-icon icon-name="utility:delete" alternative-text="Delete"
                                            onclick={deleteLineItem} data-index={index} variant="destructive">
                                        </lightning-button-icon>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>

                    <!-- Total Amount -->
                    <!-- <div class="slds-m-top_medium total-section">
                        <div class="slds-text-heading_small">
                            Total Amount: <lightning-formatted-number value={totalAmount} style="currency"
                                currency-code="USD"></lightning-formatted-number>
                        </div>
                    </div> -->
                </div>

                <!-- Action Buttons -->
                <div class="slds-m-top_large slds-text-align_center">
                    <lightning-button label="Submit" variant="brand" onclick={handleSubmit} class="submit-button"
                        disabled={isLoading}>
                    </lightning-button>
                    <lightning-button label="Cancel" onclick={handleCancel} variant="neutral" class="slds-m-left_medium"
                        disabled={isLoading}>
                    </lightning-button>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <template if:true={isLoading}>
            <div class="slds-align_absolute-center slds-m-around_x-large">
                <lightning-spinner alternative-text="Loading" size="large"></lightning-spinner>
            </div>
        </template>
    </lightning-quick-action-panel>
</template>